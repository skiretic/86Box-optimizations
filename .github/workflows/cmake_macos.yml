name: CMake (macos)

on:

  push:
    paths:
      - src/**
      - cmake/**
      - "**/CMakeLists.txt"
      - "CMakePresets.json"
      - "!.github/workflows/**"
      - .github/workflows/cmake_macos.yml
      - vcpkg.json
      - "!**/Makefile*"

  pull_request:
    paths:
      - src/**
      - cmake/**
      - "**/CMakeLists.txt"
      - "CMakePresets.json"
      - "!.github/workflows/**"
      - .github/workflows/cmake_macos.yml
      - vcpkg.json
      - "!**/Makefile*"

jobs:

  macos:

    name: "${{ matrix.ui.name }}, ${{ matrix.build.name }}, ${{ matrix.dynarec.name }}, ${{ matrix.environment.arch }}"

    runs-on: ${{ matrix.environment.runner }}

    strategy:
      fail-fast: true
      matrix:
        build:
#          - name: Regular
#            preset: regular
          - name: Debug
            preset: dev_debug
            slug: -Debug
          - name: Dev
            preset: development
            slug: -Dev
        dynarec:
          - name: ODR
            new: off
            slug: -ODR
          - name: NDR
            new: on
            slug: -NDR
        ui:
          - name: SDL GUI
            qt: off
            slug: -SDL
            static: on
          - name: Qt 5 GUI
            qt: on
            slug: -Qt5
            packages: >-
              qt@5
        environment:
          - arch: x86_64
            toolchain: ./cmake/flags-gcc-x86_64.cmake
            slug: -x86_64
            runner: macos-15-intel
          - arch: arm64
            toolchain: ./cmake/llvm-macos-aarch64.cmake
            slug: -arm64
            runner: macos-14
        exclude:
          - dynarec:
              new: off
            environment:
              arch: arm64

    steps:
      - name: Install dependencies
        run: >-
          brew install
          sdl2
          rtmidi
          openal-soft
          fluidsynth
          libslirp
          vde
          libserialport
          ${{ matrix.ui.packages }}

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Configure CMake
        run: >-
          cmake -S . -B build --preset ${{ matrix.build.preset }}
          --toolchain ${{ matrix.environment.toolchain }}
          -D NEW_DYNAREC=${{ matrix.dynarec.new }}
          -D QT=${{ matrix.ui.qt }}
          -D Qt5_ROOT=$(brew --prefix qt@5)
          -D Qt5LinguistTools_ROOT=$(brew --prefix qt@5)
          -D OpenAL_ROOT=$(brew --prefix openal-soft)
          -D LIBSERIALPORT_ROOT=$(brew --prefix libserialport)

      - name: Build
        run: cmake --build build

      - name: Build NEON benchmark
        if: matrix.environment.arch == 'arm64'
        run: cmake --build build --target mmx_neon_micro

      - name: Run NEON benchmark
        if: matrix.environment.arch == 'arm64'
        run: |
          build/benchmarks/mmx_neon_micro.app/Contents/MacOS/mmx_neon_micro --iters=10000000 --impl=neon | tee mmx_neon_micro.log

      - name: Parse NEON benchmark log
        if: matrix.environment.arch == 'arm64'
        run: |
          python3 tools/parse_mmx_neon_log.py mmx_neon_micro.log --output mmx_neon_micro.json --min-ratio 0.5

      - name: Upload NEON log
        if: matrix.environment.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: 'mmx_neon_micro-log-${{ github.run_number }}'
          path: mmx_neon_micro.log

      - name: Upload NEON metrics
        if: matrix.environment.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: 'mmx_neon_micro-metrics-${{ github.run_number }}'
          path: mmx_neon_micro.json

      - name: Build dynarec benchmark
        if: matrix.environment.arch == 'arm64'
        run: cmake --build build --target dynarec_micro

      - name: Run dynarec benchmark
        if: matrix.environment.arch == 'arm64'
        run: |
          build/benchmarks/dynarec_micro.app/Contents/MacOS/dynarec_micro --iters=10000000 --impl=neon | tee dynarec_micro.log

      - name: Parse dynarec benchmark log
        if: matrix.environment.arch == 'arm64'
        run: |
          python3 tools/parse_mmx_neon_log.py dynarec_micro.log --output dynarec_micro.json

      - name: Upload dynarec log
        if: matrix.environment.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: 'dynarec_micro-log-${{ github.run_number }}'
          path: dynarec_micro.log

      - name: Upload dynarec metrics
        if: matrix.environment.arch == 'arm64'
        uses: actions/upload-artifact@v4
        with:
          name: 'dynarec_micro-metrics-${{ github.run_number }}'
          path: dynarec_micro.json

      - name: Generate package
        run: cmake --install build

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: '86Box${{ matrix.ui.slug }}${{ matrix.dynarec.slug }}${{ matrix.build.slug }}-macOS${{ matrix.environment.slug }}-gha${{ github.run_number }}'
          path: build/artifacts/**
